language: cpp

compiler:
    - gcc

dist: trusty
sudo: require

addons:
    apt:
        sources:
            ubuntu-toolchain-r-test
        packages:
            - gcc-6
            - g++-6
            - cppcheck
            - gprof

before_install:
    - sudo ln -s /usr/bin/gcc-6 /usr/local/bin/gcc
    - sudo ln -s /usr/bin/g++-6 /usr/local/bin/g++

install:
    - DEPS_DIR="${TRAVIS_BUILD_DIR}/deps"
    - mkdir ${DEPS_DIR} && cd ${DEPS_DIR}
    - |
      if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
          CMAKE_URL="http://www.cmake.org/files/v3.15/cmake-3.15.3-Linux-x86_64.tar.gz"
          mkdir cmake && travis_retry wget --no-check-certificate --quiet -O - ${CMAKE_URL} | tar --strip-components=1 -xz -C cmake
          export PATH=${DEPS_DIR}/cmake/bin:${PATH}
      fi

    # Go to the Root directory
    - cd ..

# Build steps
script:
    - gcc -v && g++ -v
    - mkdir build_test
    - cd build_test
    - ${DEPS_DIR}/cmake/bin/cmake .. -DCMAKE_BUILD_TYPE=Tests && make
    - ./Tests
    - cd ..
    - mkdir build
    - cd build
    - ${DEPS_DIR}/cmake/bin/cmake .. && make
    - ./Raytracer
    - cppcheck --quiet --error-exitcode=1 .
    - gprof ./Raytracer > gprof.log
    - head gprof.log -n 100
